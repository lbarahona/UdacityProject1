'use strict';angular.module("utility").directive("allSetModal",["cacheVersion","modal",function(d){return{templateUrl:"/templates/chat/all_set_modal.html?"+d}}]);angular.module("utility").filter("array",function(){return function(d){return _.values(d)}});angular.module("utility").directive("chatBox",["cacheVersion","chatDataStore","currentUser",function(d,f){return{templateUrl:"/templates/chat/chat_box.html?"+d,scope:{recipientId:"@"},link:function(a,c){a.recipient=f.getChannelObjectFromId(a.recipientId);a.focused=!0;a.mention={mentionState:!1};a.jabberIdToUserObjectMap={};a.newMessage={messageText:null};a.userList={show:!1};a.mentionText=null;var b=function(){var a=c.find(".chat-box-messages")[0];a&&(a.scrollTop=a.scrollHeight)};a.$watchCollection("recipient.conversation",
function(){a.recipient.minimized||f.markAllMessagesRead(a.recipient);_.defer(b)});a.$watch("recipient.minimized",function(){a.recipient.minimized||_.defer(b)});var e=/@\w*$/;a.updateMentionText=function(){if(a.newMessage.messageText){var b=a.newMessage.messageText.match(e);if(b){0<b[0].length&&(a.mentionText=b[0].slice(1));a.mention.mentionState=!0;return}}a.mention.mentionState=!1;a.mentionText=null};a.toggleMinimizeOnHeaderBarClick=function(){a.recipient.minimized&&a.toggleMinimize()};a.toggleMinimize=
function(){a.recipient.minimized?(a.recipient.minimized=!1,f.unminimizeChannel(a.recipient)):a.recipient.minimized=!0};a.isCode=function(a){return"/code"===a.split(" ")[0]};var d=function(a,b){var e=a.split(b);return 1<e.length?e.slice(0,e.length-1).join(b):a};a.getNickNameFromUserId=function(a){if(a)return d(a,"-")};a.getUserNameForDisplayNextToMessage=function(b){if(b){var e=d(b,"-");return a.isStaff(b)?e+" (staff)":e}};a.getUserFromJabberId=function(a){if(a)return d(a,"@")};a.shortenName=function(a){return a&&
17<a.length?a.slice(0,14)+"...":a};a.getCodeSnippet=function(a){return a.slice(6)};a.placeUrlsInLinkTag=function(a){return a.replace(/(http[s]?:\/\/(www\.)?|www\.){1}([0-9A-Za-z-\.@:%_+~#=]+)+((\.[a-zA-Z]{2,3})+)(\/(.)*)?(\?(.)*)?/g,function(a){return'<a href="'+a+'">'+a+"</a>"})};a.mentionParticipant=function(b){b="@"+b+" ";a.newMessage.messageText||(a.newMessage.messageText="");if(null!==a.mentionText)a.newMessage.messageText=a.newMessage.messageText.replace(e,b),a.mention.mentionState=!1;else{var d=
c.find(".chat-box-input")[0].selectionStart;a.newMessage.messageText=a.newMessage.messageText.slice(0,d)+b+a.newMessage.messageText.slice(d+1)}a.mentionText=null;a.userList.show=!1};a.isStaff=function(b){if(b){var e=_.find(a.recipient.participants,function(a){return d(a.id,"@")===b});if(e)return"moderator"===e.role&&"staff.udacity.com"===e.domain}};a.sendMessage=function(b,e){f.isRoom(b)&&f.sendRoomChat(b,e);a.newMessage.messageText=null;a.mention={mentionState:!1}};a.closeChat=function(){f.removeFromOpenChannels(f.getOpenChannels(),
a.recipientId)}}}}]);angular.module("utility").service("chatDataStore",["chatServer","$timeout","currentUser","chatForm","dateTime","$log",function(d,f,a,c,b,e){var j=!1,i={roster:{users:{},rooms:{}},rooms:{},users:{},openChannels:{},courseCohortRooms:{},editedRoom:{currentlyEditing:{}},notifications:{hasUnreadMessages:!1}},g={nd001:"public"},k=_.throttle(function(){f(angular.noop)},1E3),l=function(a){return function(){var b=Array.prototype.slice.call(arguments,0);a.apply(this,b);k()}},m=function(a){try{a()}catch(b){e.error(b)}},
h={init:function(){j||(j=!0,d.startChat(g),d.roomStream.subscribe(function(a){m(function(){h.addToRooms(a)})},function(a){e.error("error getting rooms",a)},function(){}),d.directChatStream.subscribe(function(a){m(function(){h.addMessageToConversation(h.getUserInfo(a.from),a,!1)})},function(a){e.error(a)}),d.roomChatStream.subscribe(function(a){m(function(){h.addMessageToConversation(h.getRoomInfo(a.roomId),a,!0)})},function(a){e.error(a)}),d.roomPresenceStream.subscribe(function(a){m(function(){h.updateRoomParticipants(h.getRoomFromPresence(a),
a)})},function(a){e.error(a)}),d.roomJoinedStream.subscribe(function(a){m(function(){var c=h.getRoomFromPresence(a);c?c.joinedTime=b.getCurrent():e.warn("room not yet added")})},function(a){e.error(a)},function(){e.warn("room joined stream over")}),d.errorStream.subscribe(function(a){e.error(a)},function(a){e.error(a)}))},getChatDataObject:function(){return i},getRooms:function(){return i.rooms},getRoomFromPresence:function(a){return h.getRoomInfo(a.roomId)},getBookmarks:function(){return i.roster.rooms},
getCourseCohortRooms:function(){return i.courseCohortRooms},getEditedRoom:function(){return i.editedRoom},getNotifications:function(){return i.notifications},getOpenChannels:function(){return i.openChannels},setRooms:function(a){l(function(){i.rooms=a})()},setCourseCohortRooms:function(a){l(function(){i.courseCohortRooms=a})()},setBookmarks:function(a){l(function(){i.roster.rooms=a})()},setOpenChannels:function(a){l(function(){i.openChannels=a})},setNotifications:function(a){l(function(){i.notifications.hasUnreadMessages=
a})()},setEditedRoom:function(a){l(function(){i.editedRoom.currentlyEditing=h.getRoomInfo(a)})()},setEmptyConversation:function(a){return _.extend(a,{conversation:[]})},getChannelObjectFromId:function(a){return h.isRoom(a)?h.getRoomInfo(a):h.getUserInfo(a)},isRoom:function(a){return d.isRoomId(a)},getRoomsByPurpose:function(a){return _.chain(h.getBookmarks()).map(function(a,b){return h.getRoomInfo(b)}).filter(function(b){return b&&b.purpose===a}).value()},getRoomsForCourseAndCohort:function(a,b){var e=
h.getCourseCohortRooms();if(e[a]&&e[a][b])return e[a][b]},activateChannel:function(a){h.setOpenChannels(h.addToOpenChannels(a));a=h.getChannelObjectFromId(a);a.conversation||h.setEmptyConversation(a);h.markAllMessagesRead(a)},addToOpenChannels:function(a){i.openChannels[a]=1;k()},joinRoom:function(a){d.joinRoom(a.id);h.saveBookmark(_.pick(a,"name","id"))},removeFromOpenChannels:function(a,b){delete a[b];k();return a},getConversation:function(a){return a.conversation},getConversationLength:function(a){return h.getConversation(a).length},
removeBookmarkObject:function(a,b){delete a[b];return a},removeBookmark:function(a,b){h.removeBookmarkObject(a,b);d.fetchRoomBookmarks().subscribe(function(a){m(function(){d.uploadRoomBookmarks(_.filter(a,function(a){return a.id!==b}))})});return a},getRoomInfo:function(a){if(a in h.getRooms())return h.getRooms()[a];var b=_.find(_.keys(h.getRooms()),function(b){if(a&&b)return b.toLowerCase()===a.toLowerCase()});return b?h.getRooms()[b]:null},getUserInfo:function(a){if(a in i.users)return i.users[a];
var b=_.find(_.keys(i.users),function(b){return b.toLowerCase()===a.toLowerCase()});if(b)return i.users[b]},createMessageObject:function(a,b){return{message:b,lineNumber:h.getConversationLength(a),resolved:b.date>a.joinedTime?!1:!0}},addMentions:function(b,e){var c=[];e.body.match("@"+a.get("jabber_id").split("@")[0])&&b.mentions&&(c=_.union(b.mentions,[h.createMessageObject(b,e)]));return _.extend(b,{mentions:c})},updateMessagesRead:function(a,b){if(a.joinedTime>b.date)return _.extend(a,{messagesRead:a.messagesRead?
a.messagesRead+1:1});(!(a.id in h.getOpenChannels())||a.id.minimized)&&h.setNotifications(!0);return a},addToConversation:function(a,b){return _.extend(a,{conversation:_.union(a.conversation||[],[b])})},sendRoomChat:function(a,b){d.sendRoomChat(a,b)},addMessageToConversation:function(a,b,c){l(function(){if(a)return c?h.updateMessagesRead(h.addMentions(h.addToConversation(a,b),b),b):h.updateMessagesRead(h.addToConversation(a,b),b);e.warn("received message from sender that is not recognized",b)})()},
processUnavailablePresence:function(a,b){return h.removeParticipant(a,b.user)},removeParticipant:function(a,b){delete a.participants[b];a.numOccupants=_.size(a.participants);return a},createParticipant:function(a){return{id:a.user,status:a.status,affiliation:a.affiliation,role:a.role,domain:a.domain}},processAvailablePresence:function(a,b){a.participants[b.user]=h.createParticipant(b);a.numOccupants=_.size(a.participants);var e=_.object([b.user],[h.createParticipant(b)]);_.defer(k);return _.extend(a,
{participants:_.extend(a.participants||{},e),numOccupants:_.size(a.participants)})},createEmptyRoom:function(){return{category:"conference",cohort:"",conversation:[],course:"",description:"",id:"",name:"",numOccupants:0,purpose:"",type:"text"}},createRoomFromSelfPresence:function(a){i.rooms[a.roomId]=h.createEmptyRoom();return i.rooms[a.roomId]},updateRoomParticipants:function(a,b){if(!a)if("owner"===b.affiliation&&b.isCurrentUser)a=h.createRoomFromSelfPresence(b);else{e.warn("id not found for given presence element",
b);return}a.participants=a.participants||{};if("unavailable"===b.type)return h.processUnavailablePresence(a,b);if("unavailable"!==b.type)return h.processAvailablePresence(a,b)},leaveAllRooms:function(){_.forEach(h.getBookmarks(),function(a){d.leaveRoom(a.id)})},uploadRoomBookmarks:function(a){d.uploadRoomBookmarks(a);return h.setBookmarks(a)},setRoomMinimized:function(a){return _.extend(a,{minimized:!0})},addRoomObject:function(a,b){("General Discussion"===b.name||"Projects"===b.name)&&h.joinRoom(b);
return _.extend(a,_.object([b.id],[b]))},addRoomToCourseCohortRooms:function(a,b,e,c){var d=c.id;a[b]=a[b]||{};a[b][e]=a[b][e]||{};a[b][e][d]=c;return a},addToRooms:function(a){var a=h.setRoomMinimized(a),b=h.getRoomInfo(a.id);b&&(a=_.extend(b,a),h.removeRoomObject(h.getRooms(),b.id));h.setRooms(h.addRoomObject(h.getRooms(),a));h.setCourseCohortRooms(h.addRoomToCourseCohortRooms(h.getCourseCohortRooms(),a.course,a.cohort,a));a.isBookmarked&&(d.joinRoom(a.id),h.setBookmarks(h.addBookmark(h.getBookmarks(),
a.id)))},addBookmark:function(a,b){return _.extend(a,_.object([b],[1]))},saveBookmark:function(a){if(a.id){var b=h.addBookmark(h.getBookmarks(),a.id);d.fetchRoomBookmarks().subscribe(function(b){_.find(b,function(b){return b.id===a.id})||d.uploadRoomBookmarks(_.union(b,[a]))});return b}},editRoom:function(a,b){d.editRoom(a,b).subscribe(function(a){m(function(){c.setRoomEditSucceeded();h.addToRooms(a)})},function(a){m(function(){e.warn("room was not edited");c.setRoomEditFailed();e.error(a)})})},createRoom:function(a,
b,k,g){return d.createCustomRoom(a,b,k,g).subscribe(function(a){m(function(){h.saveBookmark(a);c.setRoomCreationSucceeded()})},function(a){e.warn("room was not created");c.setRoomCreationFailed();e.error(a)})},leaveRoom:function(a){h.setBookmarks(h.removeBookmark(h.getBookmarks(),a.id));d.leaveRoom(a.id)},hasBookmark:function(a){return h.getBookmarks()[a]},pruneOpenChannels:function(a){if(a&&0<=a)for(;_.size(h.getOpenChannels())>a;){var b=_.first(_.keys(h.getOpenChannels()));h.setOpenChannels(h.removeFromOpenChannels(h.getOpenChannels(),
b))}},markNonMentioningMessagesAsRead:function(a){return _.extend(a,{messagesRead:h.getConversationLength(a)})},markMentioningMessagesAsRead:function(a){return _.extend(a,{mentions:_.map(a.mentions,function(a){return _.extend(a,{resolved:!0})})})},markAllMessagesRead:function(a){return a.mentions?h.markNonMentioningMessagesAsRead(h.markMentioningMessagesAsRead(a)):h.markNonMentioningMessagesAsRead(a)},unminimizeChannel:function(a){l(function(){_.extend(h.markAllMessagesRead(a),{minimized:!1});h.setNotifications(!1)})()},
isInOpenChannels:function(a){return h.getOpenChannels()[a.id]},removeFromCourseCohortRooms:function(a,b,e,c){a[b]&&a[b][e]&&delete a[b][e][c];return a},removeRoomObject:function(a,b){delete a[b];delete a[b.toLowerCase()];return a},deleteRoom:function(a){var b=h.getRoomInfo(a);d.deleteRoom(a,b.course,b.cohort);h.setBookmarks(h.removeBookmark(h.getBookmarks(),b.id));h.setCourseCohortRooms(h.removeFromCourseCohortRooms(h.getCourseCohortRooms(),b.course,b.cohort,a));h.setRooms(h.getRooms(),h.removeRoomObject(h.getRooms(),
a));h.setOpenChannels(h.removeFromOpenChannels(h.getOpenChannels(),a))}};return h}]);angular.module("utility").service("chatForm",["$timeout",function(d){var f=function(){return{roomName:!1,description:!1,type:!1,errorMessages:[]}},a=function(){return{createSucceeded:null,editSucceeded:null}},c=_.throttle(function(){d(angular.noop)},1E3),b={invalidFields:{data:f()},submissionResults:{data:a()},isSubmissionSuccess:function(){return b.submissionResults.data.createSucceeded||b.submissionResults.data.editSucceeded},createSubmissionSucceeded:function(){return b.submissionResults.data.createSucceeded},
createSubmissionFailed:function(){return!1===b.submissionResults.data.createSucceeded},editSubmissionSucceeded:function(){return b.submissionResults.data.editSucceeded},editSubmissionFailed:function(){return!1===b.submissionResults.data.editSucceeded},hasNewSubmissionResults:function(){return null!==b.submissionResults.data.createSucceeded||null!==b.submissionResults.data.editSucceeded},clearSubmissionResults:function(){b.submissionResults.data=a()},resetInvalidFields:function(){b.invalidFields.data=
f()},setRoomCreationSucceeded:function(){b.clearSubmissionResults();b.submissionResults.data.createSucceeded=!0},setRoomCreationFailed:function(){b.clearSubmissionResults();b.submissionResults.data.createSucceeded=!1},setRoomEditSucceeded:function(){b.clearSubmissionResults();b.submissionResults.data.editSucceeded=!0},setRoomEditFailed:function(){b.clearSubmissionResults();b.submissionResults.data.editSucceeded=!1},checkForInvalidFields:function(a,d,f){var g=_.some([a,d,f],function(a){return!a});
b.invalidFields.data.errorMessages=[];var k=/^[\w\s\!\?,\.\-_\(\)]*$/;b.resetInvalidFields();if(!a||40<a.length)b.invalidFields.data.roomName=!0,a?a.match(k)?b.invalidFields.data.errorMessages.push("Group name must be less than 40 characters"):b.invalidFields.data.errorMessages.push("Invalid characters used in name. Please use alphanumeric symbols!"):b.invalidFields.data.errorMessages.push("Missing group name"),g=!0;d?d.match(k)||(b.invalidFields.data.errorMessages.push("Invalid characters used in description. Please use alphanumeric symbols!"),
g=!0):(b.invalidFields.data.description=!0,b.invalidFields.data.errorMessages.push("Missing group description"),g=!0);f||(b.invalidFields.data.type=!0,b.invalidFields.data.errorMessages.push("Missing group type"),g=!0);c();return g}};return b}]);angular.module("utility").directive("chatGroupListModal",["cacheVersion","chatDataStore","modal","chatForm","currentUser",function(d,f,a,c,b){return{templateUrl:"/templates/chat/chat_group_list_modal.html?"+d,link:function(a){a.selectedCourse="nd001";a.selectedCohort="public";a.submissionResults=c.submissionResults;a.createSubmissionSucceeded=c.createSubmissionSucceeded;a.createSubmissionFailed=c.createSubmissionFailed;a.editSubmissionSucceeded=c.editSubmissionSucceeded;a.editSubmissionFailed=c.editSubmissionFailed;
a.submissionSuccess=c.isSubmissionSuccess;a.newSubmissionResults=c.hasNewSubmissionResults;a.getNumParticipants=function(a){return _.size(a.participants)};a.isOwner=function(a){var c=b.get("jabber_id");if(a.participants&&c in a.participants)return"owner"===a.participants[c].affiliation};a.joinAndBookmarkGroup=function(a){f.joinRoom(a)};a.deleteGroup=function(a){f.deleteRoom(a)};a.getGroupsOfType=function(a,b,c){return(b=f.getRoomsForCourseAndCohort(b,c))?_.filter(b,function(b){return b.purpose===
a}):null};a.isInBookmarks=function(a){return f.hasBookmark(a.id)};a.leaveGroupAndRemoveBookmark=function(a){f.leaveRoom(a)}}}}]);angular.module("utility").directive("chatPanel",["cacheVersion","chatDataStore","currentUser","fetchDiscourseLink","$window",function(d,f,a,c,b){return{templateUrl:"/templates/chat/chat_panel.html?"+d,link:function(e){e.purposes=["topic"];e.userName=a.get("nickname")||a.get("first_name");e.getGroupsByPurpose=f.getRoomsByPurpose;c().then(function(a){e.forumLink=a});e.openForum=function(){e.forumLink&&b.open(e.forumLink)};e.openNdPortal=function(){b.open("/course/nd001")};e.numBookmarks=function(){return _.size(f.getBookmarks())};
e.getMaxNumberOfChatBoxes=function(){var a=$(b).width();return 1200<a?3:992<a?2:1};var d=function(){_.size(f.getOpenChannels())>=e.getMaxNumberOfChatBoxes()&&f.pruneOpenChannels(e.getMaxNumberOfChatBoxes())},i=function(){d()};$(b).resize(i);e.$on("$destroy",function(){$(b).off("resize",i)});e.joinGroup=function(a){f.isInOpenChannels(a)||(d(),f.hasBookmark(a.id)||f.saveBookmark({id:a.id,name:a.name}),f.activateChannel(a.id));f.unminimizeChannel(a)};e.hasUnresolvedMentions=function(a){return!a.mentions?
!1:_.some(a.mentions,function(a){return!a.resolved})}}}}]);angular.module("utility").service("chatServer",["chatServerHelper","strophe","currentUser","dateTime","$log",function(d,f,a,c,b){var e=null,j,i,g={startChat:function(k){g.getConnection()||(e=f.createXmppServerConnection());g.connectionSubject=new Rx.BehaviorSubject;var l=function(c){var c=c||1,e=2E3*c;g.getConnection().connect(a.get("jabber_id"),a.get("external_service_password"),function(a){var d=f.getConnectionStatus(a);g.connectionSubject.onNext(d);if("disconnected"===f.getConnectionStatus(a)||
"connection failed"===f.getConnectionStatus(a))b.warn("attempting to reconnect. Attempt number",c),g.getConnection().disconnect(),b.warn("resetting connection"),g.getConnection().reset(),_.delay(l,e,c+1)})};l();g.connectionStream=g.connectionSubject.asObservable();g.connectionStream.subscribe(function(a){"connected"===a&&g.getConnection().send(f.createAvailablePresence())},function(a){console.error(a)},function(){});i=g.connectionStream.filter(function(a){return"connected"===a}).take(1);j=Rx.Observable.create(function(a){g.getConnection().addHandler(function(b){a.onNext(b);
return!0},null,null,null,null,null,null)}).publish();g.directChatStream=j.filter(d.filterDirectChatStanzas).map(d.mapDirectChatXmlToJson);g.roomChatStream=j.filter(d.filterRoomChatStanzas).map(d.mapRoomChatXmlToJson);g.roomPresenceStream=j.filter(d.filterRoomPresenceStanzas).map(d.mapRoomPresenceXmlToJson).publish();g.roomJoinedStream=g.roomPresenceStream.filter(d.filterRoomJoinedJson).map(function(a){return _.extend(a,{joinedTime:c.getCurrent()})});g.roomPresenceStream.connect();g.globalPresenceStream=
j.filter(d.filterGlobalPresenceStanzas).map(d.mapGlobalPresenceXmlToJson);g.roomJoinedFailedStream=j.filter(d.filterRoomJoinedFailedStanza).map(d.mapRoomJoinedFailedXmlToJson).subscribe(function(a){g.leaveRoom(a.id);_.delay(g.joinRoom,5E3,a.id)});g.errorStream=j.filter(d.filterErrorStanzas).map(d.mapErrorXmlToJson);g.roomStream=i.flatMap(function(){_.forEach(k,function(a,b){var c=d.createPathString(b,a);g.subscribeToPubsubNode(c)});return g.fetchRoomStream(k)});j.connect()},isRoomId:function(a){return f.isRoomId(a)},
fetchRoomStream:function(a){return Rx.Observable.merge(_.map(a,function(a,b){return g.fetchAllRoomInfoForCourseAndCohort(a,b)}))},fetchAllRoomInfoForCourseAndCohort:function(a,b){var c=d.createPathString(b,a),e=g.getNewRoomStreamAtPathWithBookmarkInfo(c),c=g.fetchRoomsAtPathWithBookmarkInfo(c);return Rx.Observable.merge(c,e).flatMap(function(a){return Rx.Observable.merge(_.map(a,g.refreshRoomInfo))})},pruneBookmarks:function(a,b){if(0<_.size(a)){var c=_.filter(b,function(b){return _.contains(_.map(a,
function(a){return a.id}),b.id)});g.uploadRoomBookmarks(c)}},refreshRoomInfo:function(a){return Rx.Observable.onErrorResumeNext(g.fetchRoomInfoFromRoomId(a.id),Rx.Observable.just()).take(1).map(function(b){return _.extend(a,b)})},subscribeToPubsubNode:function(a){return g.createIqResponseObservable(f.subscribeToPubsubNode(a)).subscribe(function(){},function(a){b.error("subscription failed",a)})},getConnection:function(){return e},pauseChat:function(){g.getConnection()&&g.getConnection().pause()},
endChat:function(){g.getConnection()&&(g.getConnection().send(f.createUnavailablePresenceElement()),g.getConnection().disconnect())},resumeChat:function(){g.getConnection()?g.getConnection().resume():g.startChat()},sendIndividualChat:function(a,b){if(g.getConnection()){var c=f.createDirectMessageElement(a,b);g.getConnection().send(c);return d.mapDirectChatXmlToJson(c)}return null},sendRoomChat:function(a,b){if(g.getConnection()){var c=f.createRoomChatMessageElement(a,b);g.getConnection().send(c);
return d.mapRoomChatXmlToJson(c)}return null},joinRoom:function(a){g.getConnection().send(f.createJoinRoomPresenceElement(a))},leaveRoom:function(a){g.getConnection().send(f.createLeaveRoomPresenceElement(a))},uploadRoomBookmarks:function(a){return g.createIqResponseObservable(f.createUploadBookmarksIqElement(a)).subscribe(function(){},function(a){console.error("bookmarks not saved",a)})},deleteBookmark:function(a,b){g.uploadRoomBookmarks(_.filter(a,function(a){return!_.isEqual(a,b)}))},deleteRoom:function(a,
c,e){c=d.createPathString(c,e);g.createIqResponseObservable(f.createDeleteRoomIqElement(a)).subscribe(function(){},function(a){b.error("deleting room failed",a)});g.createIqResponseObservable(f.createDeletePubsubItemElement(c,a)).subscribe(function(){},function(a){b.error("deleting pubsub room failed",a)})},fetchRoomBookmarks:function(){return Rx.Observable.onErrorResumeNext(g.createIqResponseObservable(f.createGetBookmarksIqElement()).doOnError(function(a){d.filterItemNotFoundStanza(a)&&g.uploadRoomBookmarks([])}).map(d.mapBookmarksXmlToJson),
Rx.Observable.just([])).take(1)},fetchRoomInfoFromRoomId:function(a){return g.createIqResponseObservable(f.createRoomInfoQuery(a)).map(d.mapRoomInfoQueryResponseXmlToJson)},fetchOpenRooms:function(){return Rx.Observable.create(function(a){g.getConnection().sendIQ(f.createOpenRoomsQuery(),function(b){a.onNext(b);a.onCompleted()},function(a){console.warn(a)})}).take(1).map(d.mapOpenRoomsXmlToJson)},createRoom:function(a,b){var c=j.filter(d.filterRoomCreatedStanzas(a)).take(1).flatMap(b);g.getConnection().send(f.createNewRoomPresenceElement(a));
return c},createRoomConfigurationStream:function(a){return g.createIqResponseObservable(f.createRequestConfigFormQueryElement(a))},createCustomRoom:function(a,b,c,e){var i=d.createPathString(b,c),b=f.getRoomJabberIdFromRoomName(a.roomName);return g.createRoom(b,g.configureRoom(a,b)).do(function(a){a&&g.saveRoomAtPath(i,e,a)}).flatMap(function(a){return g.refreshRoomInfo({id:a})})},editRoom:function(a,b){return g.configureRoom(a,b).flatMap(function(a){if(a)return g.refreshRoomInfo({id:a})})},createIqResponseObservable:function(a){return Rx.Observable.create(function(b){g.getConnection().sendIQ(a,
function(a){b.onNext(a);b.onCompleted()},function(a){b.onError(a);b.onCompleted()})}).take(1)},saveRoomAtPath:function(a,c,e){return g.createIqResponseObservable(f.createUploadRoomAccessIqElement(a,c,e)).subscribe(function(){},function(a){b.error("room not saved",a)})},configureRoom:function(a,b){return g.createRoomConfigurationStream(b).flatMap(function(c){return d.filterNoConfigPossibleStanza(c,b)?Rx.Observable.throw(Error("configurations not allowed")):Rx.Observable.onErrorResumeNext(g.createIqResponseObservable(f.createNewConfiguredRoomQueryElement(a,
b)),Rx.Observable.just()).take(1).map(d.getConfiguredRoomId(b))})},createConfiguredNode:function(a){return g.createIqResponseObservable(f.createConfiguredNodeElement(a)).subscribe(function(){g.subscribeToPubsubNode(a)},function(a){b.error("node creation failed",a)})},fetchRoomsAtPath:function(a){var b=f.createGetRoomAtNodesIqElement(a);return Rx.Observable.onErrorResumeNext(g.createIqResponseObservable(b).doOnError(function(b){d.filterItemNotFoundStanza(b)&&g.createConfiguredNode(a)}).map(d.mapPubSubRoomAtNodesResult),
Rx.Observable.just([])).take(1)},fetchRoomsAtPathWithBookmarkInfo:function(a){return g.fetchRoomsAtPath(a).combineLatest(g.fetchRoomBookmarks(),function(a,b){return{roomList:a,bookmarkList:b}}).take(1).do(function(a){g.pruneBookmarks(a.roomList,a.bookmarkList)}).map(d.combineRoomAndBookmarkLists)},getNewRoomStreamAtPath:function(a){return j.filter(d.filterPubSubUpdateForNode(a)).filter(d.filterPubsubUpdateHasRoomNodeUpdate).map(d.mapPubSubRoomNodeUpdate)},getNewRoomStreamAtPathWithBookmarkInfo:function(a){return g.getNewRoomStreamAtPath(a).map(function(a){return _.map(a,
function(a){return _.extend(a,{isBookmarked:!1})})})},createDefaultRoom:function(a){var b=f.getRoomJabberIdFromRoomName(a);return g.createRoom(b,function(){return Rx.Observable.fromCallback(g.getConnection().sendIQ)(f.createNewInstantRoomQueryElement(a)).map(function(a){return"result"===a.getAttribute("type")})})},revokeVoice:function(a,b,c){a=f.createRevokeVoiceQuery(a,b,c);g.getConnection().sendIQ(a,function(){})},grantVoice:function(a,b,c){a=f.createGrantVoiceQuery(a,b,c);g.getConnection().sendIQ(a,
function(){})},fetchRoster:function(){return g.createIqResponseObservable(f.createRosterQuery()).map(d.mapRosterXmlToJson)},getCurrentUserId:function(){return a.get("jabber_id")}};return g}]);angular.module("utility").service("chatServerHelper",["strophe",function(d){var f={mapPubSubRoomItemToJson:function(a,c){var b=d.getChild(a,"purpose");return{id:a.getAttribute("id"),purpose:d.getChild(b,"value").textContent,course:c.split("/")[0],cohort:c.split("/")[1]}},mapPubSubRoomAtNodesResult:function(a){if(a=d.getChild(a,"items")){var c=a.getAttribute("node");return _.chain(a.childNodes).filter(f.filterRoomNode).map(function(a){return f.mapPubSubRoomItemToJson(a,c)}).value()}console.warn("no items element in pubsub response")},
mapPubSubRoomNodeUpdate:function(a){var c=d.getChild(a,"items").getAttribute("node"),a=d.getChild(a,"item");return[f.mapPubSubRoomItemToJson(a,c)]},getConfiguredRoomId:function(a){return function(c){return"error"===c.getAttribute("type")?(console.warn("bad configurations passed in"),null):a}},createPathString:function(a,c){return"public"===a?"public":a+"/"+c},filterNoConfigPossibleStanza:function(a,c){return f.filterStanza(a,"iq",{from:c,type:"result"},["query"])&&0===d.getChild(a,"query").childElementCount},
filterRoomNode:function(a){return f.filterStanza(a,"item",{},["entry"])&&a.getAttribute("id")&&d.getChild(a,"entry")&&d.getChild(d.getChild(a,"entry"),"purpose")},filterPubsubUpdateHasRoomNodeUpdate:function(a){return(a=d.getChild(a,"item"))&&f.filterRoomNode(a)},filterRoomJoinedFailedStanza:function(a){return f.filterStanza(a,"presence",{type:"error"},["x","error"])&&f.filterStanza(d.getChild(a,"error"),"error",{type:"cancel"},["service-unavailable"])},filterNoBookmarkNodeStanza:function(a){return f.filterStanza(a,
"iq",{type:"error"},["error","pubsub"])&&f.filterStanza(d.getChild(a,"error"),"error",{code:"404",type:"cancel"},["item-not-found"])},filterPubsubStanza:function(a){return f.filterStanza(a,"iq",{type:"result",from:d.getPubsubDomain()},["pubsub"])&&f.filterStanza(d.getChild(a,"pubsub"),"pubsub",{xmlns:"http://jabber.org/protocol/pubsub"},["items"])},filterStanza:function(a,c,b,e){if(!a)return!1;var c=c?a.tagName.toLowerCase()===c:!0,d=0===_.filter(_.keys(b),function(c){return"string"===typeof a.getAttribute(c)?
a.getAttribute(c).toLowerCase()!==b[c].toLowerCase():a.getAttribute(c)!==b[c]}).length,e=0===_.filter(e,function(b){return 0===a.getElementsByTagName(b).length}).length;return c&&d&&e},filterDirectChatStanzas:function(a){return f.filterStanza(a,"message",{type:"chat"},["body"])},filterRoomChatStanzas:function(a){return f.filterStanza(a,"message",{type:"groupchat"},["body"])&&!f.filterStanza(d.getChild(a,"status"),"status",{code:"100"},[])},filterRoomPresenceStanzas:function(a){return f.filterStanza(a,
"presence",{},["x"])&&f.filterStanza(d.getChild(a,"x"),"x",{xmlns:"http://jabber.org/protocol/muc#user"},["item"])},filterItemNotFoundStanza:function(a){return f.filterStanza(a,"iq",{type:"error"},["error","pubsub"])&&f.filterStanza(d.getChild(a,"error"),"error",{type:"cancel"},["item-not-found"])},filterRoomJoinedJson:function(a){return"110"===a.status},filterGlobalPresenceStanzas:function(a){return f.filterStanza(a,{name:"presence",xmlns:null})},filterMaxUsersInRoomError:function(a,c){return f.filterStanza(a,
"presence",{from:d.getJabberIdForUserInRoom(c),type:"error"},["x","error"])&&f.filterStanza(d.getChild(a,"error"),"error",{by:c,type:"cancel"},["not-acceptable"])},filterPubSubUpdateForNode:function(a){return function(c){return f.filterStanza(c,"message",{from:d.getPubsubDomain()},["event"])&&f.filterStanza(d.getChild(c,"items"),"items",{node:a},["item"])&&!d.getChild(c,"delay")}},filterRoomCreatedStanzas:function(a){return function(c){var b=d.getChild(c,"x"),e=null;b&&(e=d.getChild(b,"item"));return b&&
e&&f.filterStanza(c,"presence",{from:d.getJabberIdForUserInRoom(a)},["x"])&&f.filterStanza(b,"x",{xmlns:"http://jabber.org/protocol/muc#user"},["item","status"])&&f.filterStanza(d.getChild(b,"status"),"status",{code:"110"},[])&&"owner"===e.getAttribute("affiliation")}},filterErrorStanzas:function(a){return f.filterStanza(a,"error",{},[])||f.filterStanza(a,null,{type:"error"},[])},mapDirectChatXmlToJson:function(a){return{from:d.getBareJid(a.getAttribute("from")),to:d.getBareJid(a.getAttribute("to")),
body:d.getChildText(a,"body"),date:d.getDate(a)}},mapRoomChatXmlToJson:function(a){return{from:d.getUserNameFromRoomJid(a.getAttribute("from")),roomId:d.getBareJid(a.getAttribute("from")),to:d.getBareJid(a.getAttribute("to")),body:d.getChildText(a,"body"),date:d.getDate(a)}},mapRoomJoinedFailedXmlToJson:function(a){return{id:d.getBareJid(a.getAttribute("from")),code:d.getChild(a,"error").getAttribute("code")}},mapRoomPresenceXmlToJson:function(a){var c=null,b=null,e=null,f=null,i=null,g=d.getChild(a,
"status");g&&(c=g.getAttribute("code"));if(g=d.getChild(a,"item"))b=g.getAttribute("affiliation"),e=g.getAttribute("role"),f=d.getDomainFromJid(g.getAttribute("jid")),i=d.getBareJid(g.getAttribute("jid"));return{user:i,roomId:d.getBareJid(a.getAttribute("from")),type:a.getAttribute("type"),status:c,role:e,affiliation:b,domain:f,show:d.getChildText(a,"show"),isCurrentUser:"110"===d.getStatusCode(a)}},mapGlobalPresenceXmlToJson:function(a){return{user:a.getAttribute("from"),type:a.getAttribute("type")||
"available",status:d.getChildText(a,"status"),show:d.getChildText(a,"show")}},mapErrorXmlToJson:function(a){return{message:(new XMLSerializer).serializeToString(a)}},mapRosterXmlToJson:function(a){if(a=d.getChild(a,"query"))return a=a.getElementsByTagName("item"),_.map(a,function(a){return{id:a.getAttribute("jid"),name:a.getAttribute("name"),subscription:a.getAttribute("subscription"),group:d.getChildText(a,"group")}})},mapOpenRoomsXmlToJson:function(a){a=a.getElementsByTagName("item");return _.map(a,
function(a){return{id:a.getAttribute("jid"),name:a.getAttribute("name")}})},combineRoomAndBookmarkLists:function(a){var c=a.bookmarkList;return _.map(a.roomList,function(a){var e=!1;_.contains(_.map(c,function(a){return a.id}),a.id)&&(e=!0);return _.extend(a,{isBookmarked:e})})},mapBookmarksXmlToJson:function(a){if(f.filterNoBookmarkNodeStanza(a))return[];a=d.getChild(a,"storage");return _.chain(a.childNodes).filter(function(a){return"conference"===a.tagName.toLowerCase()}).map(function(a){return{name:a.getAttribute("name"),
id:a.getAttribute("id")}}).value()},mapRoomInfoQueryResponseXmlToJson:function(a){var c=d.getChild(a,"identity"),b=_.chain(_.range(c.attributes.length)).map(function(a){return c.attributes[a].nodeName}).value(),b=_.object(b,_.map(b,function(a){return c.getAttribute(a)})),a=d.getChild(a,"x"),e={};a&&a.childNodes&&(a=_.filter(a.childNodes,function(a){return"field"===a.tagName.toLowerCase()&&a.getAttribute("label")}),e=_.object(_.map(a,function(a){return d.getRoomInfoToAttributesMap()[a.getAttribute("var")]}),
_.map(a,function(a){return d.getChildText(a,"value")})));e.numOccupants&&(e.numOccupants=parseInt(e.numOccupants));return _.extend(b,e)}};return f}]);angular.module("utility").directive("createChatGroupModal",["cacheVersion","chatDataStore","modal","chatForm","$timeout",function(d,f,a,c,b){return{templateUrl:"/templates/chat/create_chat_group_modal.html?"+d,link:function(e){e.groups=f.getRooms();var d=_.throttle(function(){b(angular.noop)},10);c.resetInvalidFields();c.clearSubmissionResults();e.invalidFields=c.invalidFields;e.isInGroup=function(a){if(a)return f.hasBookmark(a.id)};e.joinGroupAndChangeModal=function(b){a.confirm();e.openChatGroupListModal();
f.joinRoom(b)};e.createRoom=function(b,g,k){c.checkForInvalidFields(b,g,k)||("topic"===k?(f.createRoom({roomName:b,description:g,membersOnly:0},"nd001","public","topic"),e.groupType="topic"):(f.createRoom({roomName:b,description:g,membersOnly:0},"nd001","public","study"),e.groupType="study"),a.confirm(),e.openChatGroupListModal(),d())}}}}]);angular.module("utility").directive("editGroupDescription",["cacheVersion","$timeout","$filter",function(d,f,a){return{templateUrl:"/templates/chat/edit_group_description.html?"+d,link:function(c,b){var e=_.throttle(function(){f(angular.noop)},1E3);c.suggestionsView={close:!1,groupNameInputHasFocus:!1};b.find("#name").focus(function(){c.suggestionsView.groupNameInputHasFocus=!0;c.suggestionsView.close=!1;e()});b.find("#name").blur(function(){c.suggestionsView.groupNameInputHasFocus=!1;e()});c.showSuggestions=
function(){c.suggestions=a("filter")(_.values(c.groups),c.newAttributes.groupName);return c.newAttributes.groupName&&c.suggestionsView.groupNameInputHasFocus&&!c.suggestionsView.close&&0<c.suggestions.length}}}}]);angular.module("utility").directive("editChatGroupModal",["cacheVersion","chatDataStore","modal","$timeout","chatForm",function(d,f,a,c,b){return{templateUrl:"/templates/chat/edit_chat_group_modal.html?"+d,link:function(e){e.invalidFields=b.invalidFields;e.editedGroup=f.getEditedRoom();var d=_.throttle(function(){c(angular.noop)},1E3);e.newAttributes={groupName:null,description:null};e.$watch("editedGroup.currentlyEditing",function(){if(!_.isEmpty(e.editedGroup.currentlyEditing)){var a=e.editedGroup.currentlyEditing;
e.newAttributes.groupName=a.name;e.newAttributes.description=a.description;e.groupId=a.id;d()}});e.editGroup=function(){var c={roomName:e.newAttributes.groupName,description:e.newAttributes.description};b.checkForInvalidFields(c.roomName,c.description,!0)||(f.editRoom(c,e.groupId),a.confirm(),e.openChatGroupListModal())}}}}]);angular.module("utility").directive("groupChat",["cacheVersion","$window","chatDataStore","modal","api","currentUser","chatForm","$timeout","showChat",function(d,f,a,c,b,e,j,i,g){return{templateUrl:"/templates/chat/group_chat.html?"+d,link:function(b){var d=_.throttle(function(){i(angular.noop)},10),f=!1;b.showGroupChat=!1;g.getGroupChatPromise().then(function(d){b.showGroupChat=d;b.showGroupChat&&!f&&(a.init(),e.checkIfFirstChatVisit().then(function(a){0<a.data.tags_added.length?(b.isFirstVisit=
!0,b.inIntroFlow=!0,c.activate("introToChatModal").then(function(){},function(){b.inIntroFlow=!1})):(b.isFirstVisit=!1,b.inIntroFlow=!1);return!0}),f=!0)});b.showChat=!1;b.isStaff=e.isStaff;b.isFirstVisit=!0;b.inIntroFlow=!0;b.showChatWidget=function(){return!1===b.inIntroFlow||!1===b.isFirstVisit};b.groupType="topic";b.openChatGroupListModal=function(){c.activate("chatGroupListModal").then(function(){j.clearSubmissionResults()},function(){j.clearSubmissionResults();b.inIntroFlow=!1})};b.showCreateGroupModal=
function(){c.activate("createChatGroupModal").then(function(){},function(){b.inIntroFlow=!1})};b.showGetStartedModal=function(){c.activate("getStartedModal").then(function(){b.inIntroFlow=!1},function(){b.inIntroFlow=!1})};b.showEditGroupModal=function(e){a.setEditedRoom(e);c.activate("editChatGroupModal").then(function(){},function(){b.inIntroFlow=!1})};b.notifications=a.getNotifications();b.markRead=function(){b.notifications.hasUnreadMessages=!1};b.toggleChat=function(){b.showChat=!b.showChat;
b.markRead();d()};b.openChannelIds=a.getOpenChannels();b.getNumOpenChannels=function(){return _.size(b.openChannelIds)};b.activateChatGroupListModal=function(a){c.confirm();b.groupType=a;b.openChatGroupListModal()};b.activateAllSetModal=function(){c.activate("allSetModal").then(function(){b.inIntroFlow=!1},function(){b.inIntroFlow=!1})}}}}]).directive("chatWidget",["cacheVersion",function(d){return{templateUrl:"/templates/chat/chat_widget.html?"+d,link:function(){}}}]);angular.module("utility").directive("introToChatModal",["cacheVersion","modal",function(d){return{templateUrl:"/templates/chat/intro_to_chat_modal.html?"+d,link:function(){}}}]);angular.module("utility").service("strophe",["currentUser","dateTime",function(d,f){var a={};a[Strophe.Status.ERROR]="error";a[Strophe.Status.CONNECTING]="connecting";a[Strophe.Status.AUTHENTICATING]="connecting";a[Strophe.Status.CONNECTED]="connected";a[Strophe.Status.CONNFAIL]="connection failed";a[Strophe.Status.AUTHFAIL]="connection failed";a[Strophe.Status.DISCONNECTED]="disconnected";a[Strophe.Status.DISCONNECTING]="disconnecting";a[Strophe.Status.ATTACHED]="attached";var c={getJabberId:function(){return d.get("jabber_id")},
getConnectionStatus:function(b){return a[b]},getBareJid:function(a){if(a)return Strophe.getBareJidFromJid(a)},getDomainFromJid:function(a){if(a)return Strophe.getDomainFromJid(a)},getNodeFromJid:function(a){if(a)return Strophe.getNodeFromJid(a)},getRoomDomain:function(){return"conference.udacity.com"},getRoomJid:function(a){return a+"@"+c.getRoomDomain()},getUserNameFromRoomJid:function(a){return 0<a.split("/").length?a.split("/")[1]:null},createAvailablePresence:function(){return $pres().c("x",{xmlns:"http://jabber.org/protocol/muc"},
"").tree()},getNickNameFromJabberId:function(a){if(a)return Strophe.getNodeFromJid(a)},getJabberIdForUserInRoom:function(a){return a+"/"+c.getNickName()},getPubsubDomain:function(){return"pubsub.udacity.com"},isRoomId:function(a){return Strophe.getDomainFromJid(a)===c.getRoomDomain()},getRoomInfoToAttributesMap:function(){return{"muc#roominfo_description":"description","muc#roominfo_subject":"subject","muc#roomconfig_changesubject":"allowChangeSubject","muc#roominfo_occupants":"numOccupants","muc#roominfo_lang":"language",
"muc#maxhistoryfetch":"maxHistory","muc#roominfo_pubsub":"pubsub"}},getRoomAttributesToMucAttributesMap:function(){return{roomName:"muc#roomconfig_roomname",description:"muc#roomconfig_roomdesc",language:"muc#roomconfig_lang",logging:"muc#roomconfig_enablelogging",allowChangeSubject:"muc#roomconfig_changesubject",allowInvites:"muc#roomconfig_allowinvites",allowPrivateMessages:"muc#roomconfig_allowpm",maxUsers:"muc#roomconfig_maxusers",rolesForPresenceBroadcast:"muc#roomconfig_presencebroadcast",rolesThatCanGetMemberList:"muc#roomconfig_getmemberlist",
publiclySearchable:"muc#roomconfig_publicroom",persistent:"muc#roomconfig_persistentroom",moderated:"muc#roomconfig_moderatedroom",membersOnly:"muc#roomconfig_membersonly",passwordRequired:"muc#roomconfig_passwordprotectedroom",password:"muc#roomconfig_roomsecret",whoCanDiscoverRealJabberIds:"muc#roomconfig_whois",maxHistory:"muc#maxhistoryfetch",additionalRoomAdmins:"muc#roomconfig_roomadmins",additionalRoomOwners:"muc#roomconfig_roomowners"}},mapRoomAttributes:function(a){var e=c.getRoomAttributesToMucAttributesMap();
return _.object(_.map(_.keys(a),function(a){return e[a]}),_.map(_.values(a),function(a){return null===a?"none":String(a)}))},createRosterQuery:function(){return $iq({from:c.getJabberId(),type:"get",id:"roster"}).c("query",{xmlns:"jabber:iq:roster"}).tree()},createNewRoomPresenceElement:function(a){a={from:c.getJabberId(),to:c.getJabberIdForUserInRoom(a)};return $pres(a).c("x",{xmlns:"http://jabber.org/protocol/muc"}).tree()},getRoomJabberIdFromRoomName:function(a){var a=a.replace(/[\~\!\*\(\)\'\s]/g,
""),e=_.chain(_.range(0,5)).map(function(){return String.fromCharCode(65+Math.floor(26*Math.random()))}).reduce(function(a,b){return a.concat(b)},"").value();return encodeURI(a)+"-"+Date.now()+e+"@"+c.getRoomDomain()},createNewInstantRoomQueryElement:function(a){var a={from:c.getJabberId(),to:c.getJabberIdForUserInRoom(c.getRoomJabberIdFromRoomName(a)),type:"set"},e=$q({xmlns:"http://jabber.org/protocol/muc#owner"}),d=$build("x",{xmlns:"jabber:x:data",type:"submit"});e.appendChild(d);return $iq(a).c(e).tree()},
createRequestConfigFormQueryElement:function(a){return $iq({from:c.getJabberId(),to:a,type:"get"}).c("query",{xmlns:"http://jabber.org/protocol/muc#owner"}).tree()},createGetBookmarksIqElement:function(){return $iq({from:c.getJabberId(),type:"get"}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("items",{node:"storage:bookmarks"}).tree()},createDeleteRoomIqElement:function(a){return $iq({from:c.getJabberId(),to:a,type:"set"}).c("query",{xmlns:"http://jabber.org/protocol/muc#owner"}).c("destroy").tree()},
createDeletePubsubItemElement:function(a,e){return $iq({type:"set",from:c.getJabberId(),to:c.getPubsubDomain()}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("retract",{node:a}).c("item",{id:e}).tree()},createUploadBookmarksIqElement:function(a){return c.createUploadDataIqElement("storage:bookmarks",c.createRoomBookmarkItems(a))},createUploadRoomAccessItem:function(a,c){return $build("item",{id:c}).c("entry",{xmlns:"http://www.w3.org/2005/Atom"}).c("purpose",{}).c("value",{},a).tree()},
createConfiguredNodeElement:function(a){return $iq({type:"set",from:c.getJabberId(),to:c.getPubsubDomain()}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("create",{node:a}).up().c("configure").c("x",{xmlns:"jabber:x:data",type:"submit"}).c("field",{"var":"FORM_TYPE",type:"hidden"}).c("value",{},"http://jabber.org/protocol/pubsub#node_config").up().c("field",{"var":"pubsub#access_model"}).c("value",{},"open").up().c("field",{"var":"pubsub#publish_model"}).c("value",{},"open").tree()},
createUploadRoomAccessIqElement:function(a,e,d){return c.createUploadDataIqElement(a,c.createUploadRoomAccessItem(e,d),c.getPubsubDomain())},createSubscribeToPubsubNodeElement:function(a){return $iq({type:"set",from:c.getJabberId(),to:c.getPubsubDomain()}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("subscribe",{node:a,jid:c.getJabberId()}).tree()},createRoomInfoQuery:function(a){return $build("iq",{from:c.getJabberId(),to:a,type:"get"}).c("query",{xmlns:"http://jabber.org/protocol/disco#info"}).tree()},
createGetRoomAtNodesIqElement:function(a){return $iq({type:"get",from:c.getJabberId(),to:c.getPubsubDomain()}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("items",{node:a}).tree()},createUploadDataIqElement:function(a,e,d){var f={from:c.getJabberId(),type:"set"};d&&(f.to=d);var a=$iq(f).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("publish",{node:a}).cnode(e).up().up(),g=$build("x",{xmlns:"jabber:x:data",type:"submit"}),e=[$build("field",{"var":"FORM_TYPE",type:"hidden"}).c("value",
{},"http://jabber.org/protocol/pubsub#publish-options").up(),$build("field",{"var":"pubsub#persist_items"}).c("value",{},"true").up()];_.forEach(e,function(a){g.cnode(a.tree()).up()});e=$build("publish-options",{}).cnode(g.tree()).up();a.cnode(e.tree());return a.tree()},createRoomBookmarkItems:function(a){var a=_.map(a,function(a){return $build("conference",{name:a.name,autojoin:"true",jid:a.id,id:a.id}).tree()}),d=$build("storage",{xmlns:"storage:bookmarks"});_.forEach(a,function(a){d.cnode(a).up()});
d.c("nick",{},c.getNickName());return $build("item",{id:"current"}).cnode(d.tree()).tree()},createNewConfiguredRoomQueryElement:function(a,d){var f=_.map(c.mapRoomAttributes(a),function(a,b){return $build("field",{"var":b}).c("value",{},a).tree()}),i=$build("x",{xmlns:"jabber:x:data",type:"submit"});i.cnode($build("field",{"var":"FORM_TYPE"}).c("value",{},"http://jabber.org/protocol/muc#roomconfig").tree()).up();_.forEach(f,function(a){a&&i.cnode(a).up()});f=$build("query",{xmlns:"http://jabber.org/protocol/muc#owner"}).cnode(i.tree()).tree();
return $build("iq",{from:c.getJabberId(),to:d,type:"set"}).cnode(f).tree()},createUnavailablePresenceElement:function(){return $pres({from:c.getJabberId(),type:"unavailable"}).tree()},createJoinRoomPresenceElement:function(a){var a={from:c.getJabberId(),to:c.getJabberIdForUserInRoom(a)},d=$build("x",{xmlns:"http://jabber.org/protocol/muc"}).tree();return $pres(a).cnode(d).tree()},createLeaveRoomPresenceElement:function(a){a={from:c.getJabberId(),to:c.getJabberIdForUserInRoom(a),type:"unavailable"};
return $pres(a).tree()},createRoomChatMessageElement:function(a,d){return $msg({to:a,from:c.getJabberId(),type:"groupchat"}).c("body",{},d).tree()},createDirectMessageElement:function(a,d){return $msg({to:a,from:c.getJabberId(),type:"chat"}).c("body",{},d).tree()},createOpenRoomsQuery:function(){return $iq({from:c.getJabberId(),to:"conference.udacity.com",type:"get"}).c("query",{xmlns:"http://jabber.org/protocol/disco#items"}).tree()},getNickName:function(){if(c.getJabberId())return Strophe.getNodeFromJid(c.getJabberId())},
getUserNameInRoom:function(a){if(a)return Strophe.getResourceFromJid(a)},getRoomName:function(a){if(a)return Strophe.getNodeFromJid(a)},createXmppServerConnection:function(){return new Strophe.Connection("https://rumours.udacity.com:5280/http-bind")},getServerBaseUrl:function(){return"https://rumours.udacity.com:5280"},getStatusCode:function(a){return(a=c.getChild(a,"x"))&&c.getChild(a,"status")?c.getChild(a,"status").getAttribute("code"):null},subscribeToPubsubNode:function(a){return $iq({type:"set",
to:c.getPubsubDomain(),from:c.getJabberId()}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("subscribe",{node:a,jid:c.getJabberId()}).tree()},getChild:function(a,d){if(a.hasChildNodes()){var f=a.getElementsByTagName(d);return 0<f.length?f[0]:_.find(_.map(a.childNodes,function(a){return c.getChild(a,d)}),function(a){return null!==a})}return null},getChildText:function(a,d){var f=c.getChild(a,d);return f?Strophe.getText(f):null},getDate:function(a){var c=f.getCurrent(),a=a.getElementsByTagName("delay");
0<a.length&&"urn:xmpp:delay"===a[0].getAttribute("xmlns")&&(c=a[0].getAttribute("stamp"),c=new Date(c));return c}};return c}]);
